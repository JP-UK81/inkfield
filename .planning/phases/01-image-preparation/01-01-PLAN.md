---
phase: 01-image-preparation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/optimise-images.js
  - public/work/sotogrande/*.webp
  - public/work/london-family/*.webp
  - public/work/jacob/*.webp
  - public/work/penthouse/*.webp
  - public/work/lecce/*.webp
autonomous: true
requirements:
  - IMG-01
  - IMG-02
  - IMG-03

must_haves:
  truths:
    - "All 60 source images exist in public/work/[slug]/ as WebP files"
    - "No WebP file is larger than its source JPEG (compression confirms quality 82 + resize working)"
    - "Filenames in public/work/[slug]/ are URL-safe slugs that preserve layout-encoding suffixes"
    - "Image counts per folder match source counts (11 sotogrande, 17 london-family, 8 jacob, 13 penthouse, 11 lecce)"
    - "Portrait images have correct orientation in browser (EXIF auto-rotate applied)"
  artifacts:
    - path: "scripts/optimise-images.js"
      provides: "One-time image processing script"
      contains: "slugifyFilename"
    - path: "public/work/sotogrande/"
      provides: "11 WebP images for sotogrande project"
    - path: "public/work/london-family/"
      provides: "17 WebP images for london-family project"
    - path: "public/work/jacob/"
      provides: "8 WebP images for jacob project"
    - path: "public/work/penthouse/"
      provides: "13 WebP images for penthouse project"
    - path: "public/work/lecce/"
      provides: "11 WebP images for lecce project"
  key_links:
    - from: "images to optimise/Project N - Name/"
      to: "public/work/[slug]/"
      via: "scripts/optimise-images.js PROJECTS mapping"
      pattern: "PROJECTS.*folder.*slug"
    - from: "source filename (e.g. '1.03 side by side to 1.04.jpg')"
      to: "output filename (e.g. '1.03-side-by-side-to-1.04.webp')"
      via: "slugifyFilename() function"
      pattern: "slugifyFilename"
---

<objective>
Write and run a Node.js script that converts all 60 source JPEG images into web-optimised WebP files placed in `public/work/[slug]/`, with URL-safe filenames that preserve the layout-encoding conventions Phase 2 depends on.

Purpose: Phase 2 (project pages) requires images to already be in `public/work/[slug]/` as correctly-named WebP files. This phase delivers that foundation in one repeatable script.
Output: `scripts/optimise-images.js` + 60 WebP files across 5 project directories in `public/work/`.
</objective>

<execution_context>
@/Users/jp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-image-preparation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write the image optimisation script</name>
  <files>scripts/optimise-images.js</files>
  <action>
Create `scripts/optimise-images.js` using the exact pattern from the research. The script must:

1. Require `sharp`, `fs`, and `path` — no additional dependencies (sharp 0.34.5 is already in node_modules).

2. Define the PROJECTS mapping:
```javascript
const PROJECTS = [
  { folder: 'Project 1 - Soto',       slug: 'sotogrande' },
  { folder: 'Project 2 - Hillway',     slug: 'london-family' },
  { folder: 'Project 3 - Jacob David', slug: 'jacob' },
  { folder: 'Project 4 - Oak Lodge',   slug: 'penthouse' },
  { folder: 'Project 5 - Lecce',       slug: 'lecce' },
];
```

3. Set constants:
```javascript
const SOURCE_BASE = path.join(process.cwd(), 'images to optimise');
const OUTPUT_BASE = path.join(process.cwd(), 'public', 'work');
const MAX_WIDTH = 2400;
const WEBP_QUALITY = 82;
```

4. Implement `slugifyFilename(filename)` exactly as researched and tested:
```javascript
function slugifyFilename(filename) {
  const base = filename.replace(/\.(jpg|jpeg|png|webp)$/i, '');
  return base
    .toLowerCase()
    .replace(/'/g, '')             // it's -> its, nit's -> nits (handles typo in 4.01)
    .replace(/&/g, 'and')          // & -> and (three-up filenames like 2.14)
    .replace(/\s+/g, '-')          // spaces -> hyphens
    .replace(/[^a-z0-9\-\.]/g, '') // strip remaining unsafe characters
    + '.webp';
}
```

5. Implement `processProject({ folder, slug })` that:
   - Reads ALL `.jpg`, `.jpeg`, `.png` files from the source dir (not filtering by naming pattern — this handles the anomalous `91-93 Hillway-82.jpg`)
   - Creates the output dir with `fs.mkdirSync(outDir, { recursive: true })`
   - For each file: runs the sharp pipeline `.rotate().resize({ width: MAX_WIDTH, withoutEnlargement: true }).webp({ quality: WEBP_QUALITY, effort: 4 }).toFile(outPath)`
   - NOTE: `.rotate()` with no arguments = auto EXIF orientation — NEVER skip this, it corrects portrait images shot on phones/cameras
   - NOTE: `withoutEnlargement: true` prevents upscaling smaller images (Lecce images are ~3800px, not 6000px)
   - Logs each file: `console.log(\`  \${file} -> \${outName}\`)`
   - Logs completion: `console.log(\`Done: \${slug} (\${files.length} images)\`)`

6. The main async IIFE processes projects sequentially with `for...of` — NOT Promise.all() (sharp uses 16 threads internally; 60 concurrent instances would exhaust memory on 10-15MB source files).

7. Add a comment noting the known anomalies:
```javascript
// NOTE: '91-93 Hillway-82.jpg' in Project 2 has no X.NN prefix — processed as standalone
// NOTE: '3.00 verdina da sistemare.jpg' has Italian annotation — process as-is, verify colour visually
// NOTE: '4.01 on nit's own...' has a typo — slugified to '4.01-on-nits-own-with-text-to-the-side.webp'
```

The script must be runnable with `node scripts/optimise-images.js` from the project root. It must be idempotent (safe to re-run — sharp overwrites existing output files).
  </action>
  <verify>
    <automated>node --check scripts/optimise-images.js && echo "SYNTAX OK"</automated>
    <manual>Open scripts/optimise-images.js and confirm: PROJECTS array has 5 entries with correct folder names and slugs, slugifyFilename handles apostrophes and ampersands, sharp pipeline includes .rotate() before .resize()</manual>
  </verify>
  <done>scripts/optimise-images.js exists, passes `node --check`, contains the PROJECTS mapping with all 5 projects, slugifyFilename function, and the sharp pipeline with .rotate()/.resize()/.webp()/.toFile()</done>
</task>

<task type="auto">
  <name>Task 2: Run the script and verify all 60 images are processed</name>
  <files>
    public/work/sotogrande/
    public/work/london-family/
    public/work/jacob/
    public/work/penthouse/
    public/work/lecce/
  </files>
  <action>
Run the script from the project root:
```bash
node scripts/optimise-images.js
```

Expected console output shows each of the 5 projects processing, with image counts:
- sotogrande: 11 images
- london-family: 17 images (including `91-93-hillway-82.webp`)
- jacob: 8 images (including `3.00-verdina-da-sistemare.webp`)
- penthouse: 13 images
- lecce: 11 images

After the script completes, verify outputs by checking file counts in each directory. Expected: 11 + 17 + 8 + 13 + 11 = 60 total WebP files.

If the script fails:
- "Cannot find module 'sharp'" — sharp is at node_modules/sharp, try `node -e "require('sharp')"` to confirm
- Permission error on output dirs — the script uses `fs.mkdirSync(..., { recursive: true })` which should handle creation
- Individual file error — sharp will log the problematic file; check for corrupt source JPEGs

After successful run, spot-check a few key filenames to confirm layout-encoding is preserved:
- `public/work/london-family/2.14-side-by-side-to-2.15-and-2.16.webp` should exist (& -> and)
- `public/work/penthouse/4.01-on-nits-own-with-text-to-the-side.webp` should exist (apostrophe stripped)
- `public/work/jacob/3.00-verdina-da-sistemare.webp` should exist (hero image)
- `public/work/london-family/91-93-hillway-82.webp` should exist (anomalous file)
  </action>
  <verify>
    <automated>
node -e "
const fs = require('fs');
const path = require('path');
const expected = {
  sotogrande: 11,
  'london-family': 17,
  jacob: 8,
  penthouse: 13,
  lecce: 11
};
let allOk = true;
for (const [slug, count] of Object.entries(expected)) {
  const dir = path.join('public', 'work', slug);
  if (!fs.existsSync(dir)) { console.error('MISSING dir:', dir); allOk = false; continue; }
  const files = fs.readdirSync(dir).filter(f => f.endsWith('.webp'));
  if (files.length !== count) { console.error('WRONG COUNT', slug, 'expected', count, 'got', files.length); allOk = false; }
  else { console.log('OK', slug, files.length, 'webp files'); }
}
const keyFiles = [
  'public/work/london-family/2.14-side-by-side-to-2.15-and-2.16.webp',
  'public/work/penthouse/4.01-on-nits-own-with-text-to-the-side.webp',
  'public/work/jacob/3.00-verdina-da-sistemare.webp',
  'public/work/london-family/91-93-hillway-82.webp',
];
for (const f of keyFiles) {
  if (!fs.existsSync(f)) { console.error('MISSING key file:', f); allOk = false; }
  else { console.log('OK key file:', f); }
}
if (allOk) console.log('\nALL CHECKS PASSED');
else { console.error('\nSOME CHECKS FAILED'); process.exit(1); }
"
    </automated>
    <manual>Optionally open one image from each project in a browser or Preview to confirm orientation is correct and image quality is acceptable (not blocky, not green-tinted for jacob hero if colour was corrected upstream)</manual>
  </verify>
  <done>
- 60 WebP files exist across 5 directories with correct counts (11/17/8/13/11)
- Key slug-encoded filenames confirmed present (ampersands converted, apostrophes stripped, anomalous Hillway file included)
- No WebP file is 0 bytes (all images processed successfully)
  </done>
</task>

</tasks>

<verification>
Run the automated verification node script from Task 2 to confirm all 60 files are in place with correct counts.

Additionally verify the script itself is still intact for reproducibility:
```bash
node --check scripts/optimise-images.js && echo "Script syntax OK"
```

Total expected output: 60 WebP files across 5 project subdirectories in `public/work/`.
</verification>

<success_criteria>
1. `scripts/optimise-images.js` exists and is syntax-valid
2. `public/work/sotogrande/` contains 11 `.webp` files
3. `public/work/london-family/` contains 17 `.webp` files
4. `public/work/jacob/` contains 8 `.webp` files
5. `public/work/penthouse/` contains 13 `.webp` files
6. `public/work/lecce/` contains 11 `.webp` files
7. Slugified filenames preserve layout-encoding suffixes (side-by-side, three-up, image-with-text patterns intact)
8. Anomalous files handled: `91-93-hillway-82.webp` present, `4.01-on-nits-own-with-text-to-the-side.webp` present
</success_criteria>

<output>
After completion, create `.planning/phases/01-image-preparation/01-01-SUMMARY.md` using the summary template. Include:
- What was built (script + 60 WebP files)
- Actual image counts per project
- Notable filename mappings (layout encoding examples)
- Any anomalies observed (colour cast on jacob hero, etc.)
- Confirmation that IMG-01, IMG-02, IMG-03 are satisfied
</output>
