---
phase: 02-project-pages
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/pages/work/[slug].astro
  - src/styles/global.css
autonomous: false
requirements: [PAGE-02, PAGE-04, LAYOUT-01, LAYOUT-02, LAYOUT-03, LAYOUT-04, LAYOUT-05, DESIGN-03, PAGE-05]

must_haves:
  truths:
    - "Gallery images appear in their correct layout variants — full-width, side-by-side, main+detail, three-up, image-with-text"
    - "Side-by-side and three-up rows have equal column gaps matching the row gap (32px)"
    - "On mobile, all multi-column rows stack to single column without overflow"
    - "Image-with-text layout alternates text side per occurrence (first right, next left, etc.)"
    - "The gallery is purely visual — no captions, labels, or row numbers (except LAYOUT-05 text placeholder)"
    - "Hero image for london-family is 91-93-hillway-82.webp (anomalous filename — no X.00 file exists) and the anomalous file is excluded from gallery rows"
  artifacts:
    - path: "src/pages/work/[slug].astro"
      provides: "Filename parser (parseGalleryRows) + gallery rendering using all 5 layout variants"
      min_lines: 160
      contains: "parseGalleryRows"
    - path: "src/styles/global.css"
      provides: "Gallery layout CSS: all 5 variants, gap system, mobile responsive stacking"
      contains: ".gallery-row--side-by-side"
  key_links:
    - from: "parseGalleryRows()"
      to: "public/work/[slug]/ filenames"
      via: "filename suffix pattern matching (side-by-side-to, as-small-detail-to-the-side, on-its-own-with, on-nits-own-with)"
      pattern: "side-by-side|detail-to-the-side|own-with"
    - from: ".gallery-row--image-with-text"
      to: "text-alternation logic"
      via: "even/odd index counter on image-with-text occurrences, CSS order or class variant"
      pattern: "text-left|text-right"
---

<objective>
Implement the complete gallery layout system inside [slug].astro. Parse image filenames to build typed gallery rows, then render each row using the correct layout variant. Add all gallery CSS to global.css including mobile responsive stacking.

Purpose: Delivers the editorial image gallery that makes each project page feel like a curated spread.
Output: Gallery rendering logic in [slug].astro + gallery CSS in global.css
</objective>

<execution_context>
@/Users/jp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/02-project-pages/02-CONTEXT.md
@.planning/phases/02-project-pages/02-01-SUMMARY.md

# Files this plan modifies — read current state before editing
@src/pages/work/[slug].astro
@src/styles/global.css

# Phase 1 summary — exact filenames and conventions
@.planning/phases/01-image-preparation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filename parser and gallery rendering to [slug].astro</name>
  <files>src/pages/work/[slug].astro</files>
  <action>
Extend `src/pages/work/[slug].astro` to add filename-based gallery parsing and rendering.

PATH ENCODING NOTE: Read the current file content first (use `find ... -exec cat {} \;`), then write the updated version using Bash heredoc. Never use the Edit or Write tool for this file.

## Step 1: Read directory contents at build time

In the Astro frontmatter, after destructuring props, read the image files for the current slug using Node.js `fs` (Astro runs frontmatter at build time on Node.js, not in the browser):

```javascript
import { readdirSync } from 'node:fs';
import { fileURLToPath } from 'node:url';
import path from 'node:path';

// Resolve public/work/[slug]/ relative to the project root
const projectRoot = path.resolve(fileURLToPath(import.meta.url), '../../../..');
const imageDir = path.join(projectRoot, 'public', 'work', slug);
const allFiles = readdirSync(imageDir).filter(f => f.endsWith('.webp')).sort();
```

Note: `import.meta.url` in a `src/pages/work/[slug].astro` file points to the .astro file itself. The project root is 4 levels up (src/pages/work/[slug].astro -> src/pages/work -> src/pages -> src -> project-root).

## Step 2: Determine the hero file

Hero is the first file in sorted order (already hardcoded in project data from Plan 01, but also confirm from allFiles). For london-family, the hero is `91-93-hillway-82.webp` (the anomalous file that sorts last alphabetically — it does NOT follow X.NN convention). IMPORTANT: use the hardcoded `heroFile` from project props, not auto-detection, to avoid sorting ambiguity.

## Step 3: Build gallery file list

Exclude the hero file from the gallery:
```javascript
const galleryFiles = allFiles.filter(f => f !== heroFile);
```

## Step 4: Parse gallery rows — parseGalleryRows()

Define a `parseGalleryRows(files: string[])` function that returns an array of row objects. Process the files array sequentially, consuming files as they are grouped:

### Layout detection rules (match against filename, lowercase):

**LAYOUT-01 — full-width** (default):
- Filename has no layout suffix (plain `X.NN.webp` or anomalous names like `91-93-hillway-82.webp`)
- Row: `{ type: 'full', images: [file] }`

**LAYOUT-02 — side-by-side** (2 equal columns):
- Primary file contains `-side-by-side-to-X.NN.webp` suffix (NOT followed by `-and-`)
- The referenced partner file (`X.NN.webp` from the suffix) is the next sibling
- Consume both files as one row: `{ type: 'side-by-side', images: [primaryFile, partnerFile] }`
- The partner file referenced in the suffix may itself appear as the next entry in the sorted list — when encountered as a consumed partner, skip it (do not process twice)

**LAYOUT-03 — main+detail** (2/3 main left, 1/3 detail right):
- Filename contains `-with-X.NN-as-small-detail-to-the-side` OR `-smaller-with-X.NN-as-small-detail-to-the-side`
- The detail file (`X.NN.webp`) is the partner
- Row: `{ type: 'main-detail', images: [mainFile, detailFile] }`
- Skip the partner file when encountered in the loop

**LAYOUT-04 — three-up** (3 equal columns):
- Filename contains `-side-by-side-to-X.NN-and-X.PP` (two partners listed)
- Row: `{ type: 'three-up', images: [file1, file2, file3] }`
- Skip both partner files when encountered

**LAYOUT-05 — image-with-text** (image + text column):
- Filename contains `-on-its-own-with` OR `-on-nits-own-with` (the typo in 4.01)
- Row: `{ type: 'image-text', images: [file], textSide: alternating }`
- Track an `imageTextCount` counter (starts at 0). Even count = text on right, odd count = text on left. Increment counter for each LAYOUT-05 row.
- Row: `{ type: 'image-text', images: [file], textSide: 'right' | 'left' }`

### Detection order matters:
Check four-column pattern before two-column to avoid mis-parsing `side-by-side-to-X.NN-and-X.PP` as `side-by-side-to-X.NN`.

### Consumed files tracking:
Maintain a `Set<string>` of consumed files. When building each row, add all files in that row to the set. The main loop skips files already in the set.

## Step 5: Render gallery rows in the template

Replace the empty `.project-gallery` div with:

```astro
<div class="project-gallery grid-content">
  {galleryRows.map((row) => {
    if (row.type === 'full') return (
      <div class="gallery-row gallery-row--full">
        <img src={`/work/${slug}/${row.images[0]}`} alt={title} loading="lazy" />
      </div>
    );

    if (row.type === 'side-by-side') return (
      <div class="gallery-row gallery-row--side-by-side">
        <img src={`/work/${slug}/${row.images[0]}`} alt={title} loading="lazy" />
        <img src={`/work/${slug}/${row.images[1]}`} alt={title} loading="lazy" />
      </div>
    );

    if (row.type === 'main-detail') return (
      <div class="gallery-row gallery-row--main-detail">
        <img class="main-image" src={`/work/${slug}/${row.images[0]}`} alt={title} loading="lazy" />
        <img class="detail-image" src={`/work/${slug}/${row.images[1]}`} alt={title} loading="lazy" />
      </div>
    );

    if (row.type === 'three-up') return (
      <div class="gallery-row gallery-row--three-up">
        <img src={`/work/${slug}/${row.images[0]}`} alt={title} loading="lazy" />
        <img src={`/work/${slug}/${row.images[1]}`} alt={title} loading="lazy" />
        <img src={`/work/${slug}/${row.images[2]}`} alt={title} loading="lazy" />
      </div>
    );

    if (row.type === 'image-text') return (
      <div class={`gallery-row gallery-row--image-text gallery-row--text-${row.textSide}`}>
        <img src={`/work/${slug}/${row.images[0]}`} alt={title} loading="lazy" />
        <div class="gallery-text-column">
          <p>Interior design by Inkfield.</p>
        </div>
      </div>
    );

    return null;
  })}
</div>
```

The placeholder text "Interior design by Inkfield." is intentional — real captions are deferred to v2 per CONTEXT.md decisions. Keep it brief and tasteful.

All `alt` attributes use the project title (no captions available yet; descriptive alt text is v2).
  </action>
  <verify>
    <automated>find /Users/jp/Documents -maxdepth 12 -path "*/src/pages/work/*slug*" -exec grep -c "parseGalleryRows\|gallery-row" {} \;</automated>
    <manual>
Run `npx astro dev` and inspect each project page:
- /work/sotogrande: Most images should be full-width (plain filenames); 1.03/1.04 as side-by-side pair
- /work/jacob: 3.01/3.02 side-by-side; 3.03 main with 3.04 detail; 3.05 main with 3.06 detail; 3.07 full-width
- /work/london-family: 2.02/2.03 side-by-side; 2.05 image+text; 2.06 main+detail; 2.08/2.09 side-by-side; 2.14/2.15/2.16 three-up
- /work/penthouse: 4.01 image+text (text right); 4.02/4.03 side-by-side; 4.06/4.07/4.08 three-up; 4.10/4.11 side-by-side
- /work/lecce: All full-width (plain filenames only)
Check that no images are duplicated or missing.
    </manual>
  </verify>
  <done>Gallery renders on all 5 project pages. No images appear twice or are skipped. Each row uses the correct layout variant as encoded in its filename. `npx astro build` exits 0.</done>
</task>

<task type="auto">
  <name>Task 2: Add gallery layout CSS to global.css</name>
  <files>src/styles/global.css</files>
  <action>
Append gallery layout rules to `src/styles/global.css`. Use Bash heredoc append (`cat >> ...`). Match site conventions: kebab-case, hex colours, section comment header.

CSS to append after the existing PROJECT PAGES section:

```css
/* GALLERY LAYOUTS */

/* Shared row styles */
.gallery-row {
  margin-bottom: 32px;
}

.gallery-row img {
  width: 100%;
  height: auto;
  display: block;
  object-fit: cover;
}

/* LAYOUT-01: Full-width */
.gallery-row--full img {
  width: 100%;
}

/* LAYOUT-02: Side-by-side — 2 equal columns */
.gallery-row--side-by-side {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
}

/* LAYOUT-03: Main + detail — 2/3 main, 1/3 detail, top-aligned */
.gallery-row--main-detail {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 32px;
  align-items: start;
}

/* LAYOUT-04: Three-up — 3 equal columns */
.gallery-row--three-up {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 32px;
}

/* LAYOUT-05: Image with text column */
.gallery-row--image-text {
  display: grid;
  gap: 32px;
  align-items: center;
}

/* Text on right (default, even occurrences) */
.gallery-row--text-right {
  grid-template-columns: 2fr 1fr;
}

.gallery-row--text-right img {
  grid-column: 1;
}

.gallery-row--text-right .gallery-text-column {
  grid-column: 2;
}

/* Text on left (odd occurrences) */
.gallery-row--text-left {
  grid-template-columns: 1fr 2fr;
}

.gallery-row--text-left img {
  grid-column: 2;
  grid-row: 1;
}

.gallery-row--text-left .gallery-text-column {
  grid-column: 1;
  grid-row: 1;
}

.gallery-text-column {
  padding: 24px 0;
}

.gallery-text-column p {
  font-size: 14px;
  line-height: 1.8;
  color: #666;
  margin: 0;
  font-weight: 300;
  letter-spacing: 0.3px;
}

/* GALLERY — Mobile: all multi-column rows stack to single column */
@media (max-width: 768px) {
  .gallery-row--side-by-side,
  .gallery-row--main-detail,
  .gallery-row--three-up {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .gallery-row--image-text {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  /* On mobile, reset column assignments so image always comes first */
  .gallery-row--text-left img,
  .gallery-row--text-left .gallery-text-column {
    grid-column: 1;
    grid-row: auto;
  }

  .gallery-row--text-right img,
  .gallery-row--text-right .gallery-text-column {
    grid-column: 1;
    grid-row: auto;
  }

  .gallery-row {
    margin-bottom: 16px;
  }
}
```

Note on mobile image ordering: On mobile the image always appears before the text column regardless of text-left/text-right, which means DOM order in the template matters. The template puts `<img>` before `<div class="gallery-text-column">` so the image naturally comes first when grid collapses to 1 column. The CSS resets ensure no lingering grid-column/row conflicts.
  </action>
  <verify>
    <automated>find /Users/jp/Documents -maxdepth 12 -path "*/inkfield/src/styles/global.css" -exec grep -c "gallery-row--side-by-side\|gallery-row--three-up\|gallery-row--image-text" {} \;</automated>
    <manual>
With dev server running, check each layout type visually:
- Side-by-side (sotogrande 1.03/1.04): two images equal width, same gap as row spacing
- Main+detail (jacob 3.03/3.04): left image ~2/3 width, right detail ~1/3
- Three-up (london-family 2.14/2.15/2.16): three images equal width
- Image+text (penthouse 4.01): image left ~2/3, text right ~1/3; (london-family 2.05): text on left
- Resize to mobile (< 768px): all multi-column rows stack to full-width single column, no overflow
    </manual>
  </verify>
  <done>All 5 gallery layout variants render correctly. Gaps are consistent (32px on desktop, 16px on mobile). Multi-column rows stack on mobile without overflow. Text column shows placeholder text in editorial style.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of all project pages and gallery layouts</name>
  <name>Task 3: Visual verification of all project pages and gallery layouts</name>
  <what-built>
Complete project pages: dynamic route, hero, title block, and full gallery layout system (all 5 layout variants) across all 5 projects.
  </what-built>
  <action>
Human visual verification step. No code changes required. Verify all 5 project pages render correctly with all gallery layout variants working and mobile layouts stacking cleanly.
  </action>
  <how-to-verify>
Run `npx astro dev` from the project root and check each of the 5 project pages:

1. Visit http://localhost:4321/work/sotogrande
   - Hero image fills full browser width
   - Title "Sotogrande, Family resort" and excerpt visible below
   - Gallery shows: full-width images + one side-by-side pair (1.03/1.04)

2. Visit http://localhost:4321/work/jacob
   - Gallery shows: side-by-side (3.01/3.02), main+detail (3.03/3.04), main+detail (3.05/3.06), full-width (3.07)

3. Visit http://localhost:4321/work/london-family
   - Gallery shows: image+text with text RIGHT (2.05), three-up (2.14/2.15/2.16), plus side-by-side and main+detail rows
   - Hero is the wide building exterior shot (91-93-hillway-82.webp)

4. Visit http://localhost:4321/work/penthouse
   - Gallery shows: image+text text RIGHT (4.01), side-by-side pairs, three-up (4.06/4.07/4.08)

5. Visit http://localhost:4321/work/lecce
   - All images full-width (no multi-column rows)

6. On each page, check mobile layout by resizing browser to < 768px:
   - All gallery rows stack to single column
   - No horizontal overflow
   - Images fill full width

7. Back link on each page navigates to /work
8. Run `npx astro build` in terminal — exits with code 0, no errors

Type "approved" if all checks pass, or describe any issues found.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
  <verify>
    <automated>MISSING — this is a visual checkpoint requiring human review</automated>
    <manual>Visit all 5 project pages at localhost:4321/work/[slug] and verify hero, gallery layouts, and mobile stacking as described in how-to-verify above.</manual>
  </verify>
  <done>User types "approved" confirming all 5 project pages render correctly with all gallery layout variants working, mobile layouts stacking cleanly, and npx astro build exiting 0.</done>
</task>

</tasks>

<verification>
After all tasks including checkpoint approval:
1. npx astro build exits 0 — all 5 static paths build without errors
2. All 5 layout types (full, side-by-side, main+detail, three-up, image+text) verified visually
3. Mobile stacking confirmed at < 768px — no overflow on any page
4. No images missing or duplicated in any project gallery
5. Image+text alternates sides correctly across the site
</verification>

<success_criteria>
- All 5 project pages render complete gallery from filename-parsed layout data
- All 5 layout variants work: full-width, side-by-side, main+detail, three-up, image-with-text
- Gaps are consistent (32px row and column gap on desktop)
- Mobile: all multi-column rows stack cleanly, no overflow
- User approves visual checkpoint
- npx astro build exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/02-project-pages/02-02-SUMMARY.md` following the summary template.
</output>
